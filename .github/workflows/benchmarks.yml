name: Performance Benchmarks

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    # Run benchmarks weekly on Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:
    # Allow manual triggering

jobs:
  replication-benchmarks:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7.2-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 30s

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.5'

    - name: Cache Go modules
      uses: actions/cache@v4
      with:
        path: ~/go/pkg/mod
        key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
        restore-keys: |
          ${{ runner.os }}-go-

    - name: Download dependencies
      run: go mod download

    - name: Install redis-tools
      run: sudo apt-get update && sudo apt-get install -y redis-tools
    
    - name: Wait for Redis
      run: |
        echo "Waiting for Redis to be ready..."
        for i in {1..60}; do
          if redis-cli ping 2>/dev/null | grep -q PONG; then
            echo "Redis is ready!"
            redis-cli INFO server | grep redis_version || true
            break
          fi
          echo "Attempt $i/60: waiting for Redis..."
          sleep 2
        done
        
        # Final check
        if ! redis-cli ping 2>/dev/null | grep -q PONG; then
          echo "Redis failed to start properly"
          exit 1
        fi
    
    - name: Run Replication Throughput Benchmarks
      run: |
        echo "Running replication throughput benchmarks..."
        go test -v -bench BenchmarkReplicationThroughput -benchtime=5s -benchmem
      env:
        REDIS_ADDR: localhost:6379

    - name: Run Pattern Matching Benchmarks
      run: |
        echo "Running pattern matching benchmarks..."
        go test -v -bench BenchmarkMatchPattern -benchtime=3s -benchmem ./storage/
      continue-on-error: true

    - name: Run Storage Operation Benchmarks
      run: |
        echo "Running storage operation benchmarks..."
        go test -v -bench BenchmarkStorage -benchtime=3s -benchmem ./storage/
      continue-on-error: true

  benchmark-comparison:
    runs-on: ubuntu-latest
    needs: replication-benchmarks
    if: github.event_name == 'pull_request'
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Need full history for comparison
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.5'
        
    - name: Download dependencies
      run: go mod download

    - name: Install benchcmp
      run: go install golang.org/x/tools/cmd/benchcmp@latest
      continue-on-error: true

    - name: Comment benchmark notice
      uses: actions/github-script@v7
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'ðŸš€ Performance benchmarks are running. Results will be available in the [benchmark workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}).'
          })

  memory-profiling:
    runs-on: ubuntu-latest
    services:
      redis:
        image: redis:7.2-alpine
        ports:
          - 6379:6379
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10

    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.24.5'

    - name: Download dependencies
      run: go mod download

    - name: Install redis-tools
      run: sudo apt-get update && sudo apt-get install -y redis-tools
    
    - name: Wait for Redis
      run: |
        for i in {1..30}; do
          if redis-cli ping 2>/dev/null | grep -q PONG; then
            echo "Redis is ready!"
            break
          fi
          sleep 2
        done
    
    - name: Run Memory Profile Benchmark
      run: |
        echo "Running memory profiling benchmark..."
        go test -v -bench BenchmarkReplicationThroughput -benchtime=3s -memprofile=mem.prof -cpuprofile=cpu.prof
        
        # Basic memory analysis
        if command -v go >/dev/null 2>&1; then
          echo "=== Memory Profile Summary ==="
          go tool pprof -text -nodecount=10 mem.prof || echo "Memory profile analysis not available"
          echo ""
          echo "=== CPU Profile Summary ==="  
          go tool pprof -text -nodecount=10 cpu.prof || echo "CPU profile analysis not available"
        fi
      env:
        REDIS_ADDR: localhost:6379
      continue-on-error: true

    - name: Upload profiles
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-profiles
        path: |
          *.prof
        retention-days: 7